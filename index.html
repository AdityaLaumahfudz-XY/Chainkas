<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chain-Kas: Transparansi Kas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        
        /*  Layar login*/
        #hal-login {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
        }
        .login-card { 
            background: white; border-radius: 20px; padding: 40px; width: 90%; max-width: 400px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center;
            animation: zoomIn 0.5s ease;
        }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* mata*/
        .input-password-eye { border-right: none; }
        .input-group-text-eye { background-color: white; border-left: none; cursor: pointer; color: #6c757d; }
        .input-password-eye:focus + .input-group-text-eye { border-color: #86b7fe; border-left: none; }
        input[type="password"]::-ms-reveal, input[type="password"]::-ms-clear { display: none; }
        input[type="password"]::-webkit-password-reveal-button { display: none; }

        /*DASHBOARD*/
        .role-badge { font-size: 0.8rem; letter-spacing: 1px; text-transform: uppercase; }
        .hash-text { font-family: monospace; font-size: 0.75rem; background: #eee; padding: 2px 5px; border-radius: 4px; color: #555; display: block; width: fit-content; }
        #InputBendahara { display: none; border-left: 5px solid #0d6efd; }
        #InputWalas { display: none; border-left: 5px solid #dc3545; }
        
        /* Item pending*/
        .pending-item { background: #e8f5e9; border-left: 4px solid #198754; margin-bottom: 10px; padding: 10px; border-radius: 0 5px 5px 0; } /* Hijau utk Pemasukan */
        .pending-item-out { background: #f8d7da; border-left: 4px solid #dc3545; margin-bottom: 10px; padding: 10px; border-radius: 0 5px 5px 0; } /* Merah utk Pengeluaran */

        .bukti-foto { width: 100%; max-width: 80px; height: auto; border-radius: 5px; border: 1px solid #ddd; cursor: pointer; transition: 0.2s; }
        .bukti-foto:hover { transform: scale(1.2); }

        /*peringatan*/
        .row-palsu { background-color: #ffe6e6 !important; border-left: 5px solid red !important; animation: shake 0.5s; }
        .badge-palsu { background: red; color: white; font-weight: bold; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; display: inline-block; margin-bottom: 5px; box-shadow: 0 0 10px rgba(255,0,0,0.3); }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }

        /* Status Bayar */
        .status-box { display: inline-block; width: 25px; height: 25px; line-height: 25px; text-align: center; border-radius: 4px; font-size: 0.7em; font-weight: bold; margin-right: 2px; color: white; }
        .bg-not-paid { background-color: #e9ecef; color: #adb5bd; }
        .bg-paid { background-color: #198754; box-shadow: 0 0 5px #198754; }

        .toast-container { z-index: 10000; }
        
        /*TOTAL SALDO CARD*/
        .saldo-card { background: linear-gradient(45deg, #11998e, #38ef7d); color: white; border: none; }
    </style>
</head>
<body>

<div id="hal-login">
    <div class="login-card">
        <div class="mb-3 text-primary"><i class="bi bi-safe2 display-1"></i></div>
        <h2 class="fw-bold mb-1">Chain-Kas</h2>
        <p class="text-muted small mb-4">Blockchain Class Ledger</p>
        <div class="text-start">
            <div id="loginAlertPlaceholder"></div>
            <label class="form-label fw-bold small">Masuk Sebagai:</label>
            <select id="roleSelect" class="form-select mb-3" onchange="window.cekRoleLogin()">
                <option value="" disabled selected>-- Pilih Peran --</option>
                <option value="siswa">üë• Siswa</option>
                <option value="bendahara">üìù Bendahara</option>
                <option value="walas">üõ°Ô∏è Wali Kelas</option>
            </select>
            <div id="passwordField" style="display:none;">
                <label class="form-label fw-bold small">Password:</label>
                <div class="input-group mb-3">
                    <input type="password" id="passInput" class="form-control input-password-eye" placeholder="Masukkan sandi...">
                    <span class="input-group-text input-group-text-eye" onclick="window.togglePassword()">
                        <i class="bi bi-eye" id="iconEye"></i>
                    </span>
                </div>
            </div>
            <button onclick="window.login()" class="btn btn-primary w-100 py-2 fw-bold shadow-sm">MASUK</button>
        </div>
        <div class="mt-4 pt-3 border-top small text-muted">Pass Bendahara: <b>123</b> | Walas: <b>guru</b></div>
    </div>
</div>

<div id="mainApp" class="container py-4" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-3 bg-white p-3 rounded shadow-sm">
        <div>
            <h4 class="fw-bold text-primary m-0"><i class="bi bi-wallet2"></i> Chain-Kas</h4>
            <small class="text-muted">Role: <span id="userRoleDisplay" class="badge bg-secondary role-badge">Guest</span> <span id="statusKoneksi" class="badge bg-secondary">Connecting...</span></small>
        </div>
        <button onclick="window.logout()" class="btn btn-outline-danger btn-sm"><i class="bi bi-box-arrow-right"></i> Keluar</button>
    </div>

    <div class="card shadow-sm mb-4 saldo-card">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div>
                <small class="text-white-50">TOTAL SALDO KAS SAAT INI</small>
                <h2 class="fw-bold m-0" id="displaySaldo">Rp 0</h2>
            </div>
            <div class="text-end">
                <small class="d-block"><i class="bi bi-arrow-up-circle"></i> Masuk: <span id="displayMasuk">0</span></small>
                <small class="d-block"><i class="bi bi-arrow-down-circle"></i> Keluar: <span id="displayKeluar">0</span></small>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-5">
            <div id="InputWalas" class="card shadow-sm mb-4">
                <div class="card-header bg-danger text-white fw-bold"><span><i class="bi bi-people-fill"></i> Manajemen Siswa</span></div>
                <div class="card-body">
                    <div id="walasAlertPlaceholder"></div>
                    <div class="input-group mb-3">
                        <input type="text" id="namaSiswaBaru" class="form-control" placeholder="Nama Siswa Baru...">
                        <button class="btn btn-dark" onclick="window.tambahSiswa()"><i class="bi bi-plus-lg"></i></button>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="fw-bold text-muted">Cek Status Bulan:</small>
                        <select id="filterBulanWalas" class="form-select form-select-sm w-50" onchange="window.renderManajemenSiswa()"></select>
                    </div>
                    <div class="border rounded bg-white" style="max-height: 200px; overflow-y: auto;">
                        <ul id="listStatusSiswa" class="list-group list-group-flush small"></ul>
                    </div>
                    <div class="mt-2 text-center"><small class="text-muted fst-italic" style="font-size: 0.7em;"><span class="badge bg-success">M1</span> = Minggu 1 Lunas</small></div>
                </div>
            </div>

            <div id="InputBendahara" class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white fw-bold"><i class="bi bi-pencil-square"></i> Input Transaksi</div>
                <div class="card-body">
                    <div id="bendaharaAlertPlaceholder"></div>
                    
                    <div class="mb-3">
                        <label class="small fw-bold">Kategori:</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="btnradio" id="modeMasuk" autocomplete="off" checked onclick="window.gantiModeInput('masuk')">
                            <label class="btn btn-outline-success" for="modeMasuk"><i class="bi bi-arrow-up"></i> Pemasukan</label>
                          
                            <input type="radio" class="btn-check" name="btnradio" id="modeKeluar" autocomplete="off" onclick="window.gantiModeInput('keluar')">
                            <label class="btn btn-outline-danger" for="modeKeluar"><i class="bi bi-arrow-down"></i> Pengeluaran</label>
                        </div>
                    </div>

                    <div id="panelPemasukan">
                        <div class="mb-2">
                            <label class="small fw-bold">Nama Siswa:</label>
                            <select id="inputNama" class="form-select"><option>Loading...</option></select>
                        </div>
                        <div class="mb-2">
                            <label class="small fw-bold">Jenis Pembayaran:</label>
                            <select id="tipeIuran" class="form-select" onchange="window.cekTipeIuran()">
                                <option value="kas">üìÖ Kas Rutin Bulanan</option>
                                <option value="custom">üéâ Lainnya</option>
                            </select>
                        </div>
                        <div id="formKasRutin" class="row g-2 mb-2">
                            <div class="col-6"><select id="inputBulan" class="form-select form-select-sm"></select></div>
                            <div class="col-6"><select id="inputMinggu" class="form-select form-select-sm">
                                <option value="Minggu 1">Minggu 1</option><option value="Minggu 2">Minggu 2</option>
                                <option value="Minggu 3">Minggu 3</option><option value="Minggu 4">Minggu 4</option>
                            </select></div>
                        </div>
                        <div id="formCustom" class="mb-2" style="display:none;">
                            <input type="text" id="inputKetCustom" class="form-control" placeholder="Keterangan...">
                        </div>
                    </div>

                    <div id="panelPengeluaran" style="display: none;">
                        <div class="mb-2">
                            <label class="small fw-bold">Keperluan Pengeluaran:</label>
                            <textarea id="ketPengeluaran" class="form-control" rows="2" placeholder="Contoh: Beli Spidol, Fotocopy..."></textarea>
                        </div>
                    </div>

                    <div class="row g-2 mb-2">
                        <div class="col-6"><input type="number" id="inputJumlah" class="form-control" placeholder="Rp Nominal"></div>
                        <div class="col-6"><input type="file" id="inputFoto" class="form-control form-control-sm" accept="image/*"></div>
                    </div>
                    <button onclick="window.prosesInput()" class="btn btn-primary w-100">Kirim Pengajuan</button>
                </div>
            </div>

            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-warning text-dark fw-bold d-flex justify-content-between">
                    <span><i class="bi bi-hourglass-split"></i> Menunggu Validasi</span>
                    <span id="countPending" class="badge bg-dark rounded-pill">0</span>
                </div>
                <div class="card-body bg-light" id="listPending" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
        </div>

        <div class="col-lg-7">
            
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-success text-white fw-bold">
                    <i class="bi bi-link-45deg"></i> Blockchain Ledger (Pemasukan)
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle" style="font-size: 0.9rem;">
                            <thead class="table-light">
                                <tr>
                                    <th>Waktu</th><th>Transaksi</th><th class="text-center">Bukti</th><th class="text-end">Jumlah</th><th>Hash</th>
                                </tr>
                            </thead>
                            <tbody id="listChain"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer text-center text-muted small"><i class="bi bi-shield-check"></i> Data MERAH = Dimanipulasi.</div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-header bg-dark text-white fw-bold">
                    <i class="bi bi-cart-dash"></i> Riwayat Pengeluaran
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped mb-0 align-middle" style="font-size: 0.9rem;">
                            <thead class="table-light">
                                <tr>
                                    <th>Waktu</th><th>Keperluan</th><th class="text-center">Bukti</th><th class="text-end">Jumlah</th><th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="listPengeluaran"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toastMessage">Berhasil!</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark border-0"><h5 class="modal-title fw-bold">Konfirmasi</h5></div>
      <div class="modal-body" id="confirmModalBody">Yakin?</div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-danger" id="btnConfirmYes">Ya</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, set, remove, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDCLhG1R8ss3xyu5wHEwMlhwP5P-JGD2qk",
        authDomain: "chain-kas.firebaseapp.com",
        databaseURL: "https://chain-kas-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "chain-kas",
        storageBucket: "chain-kas.firebasestorage.app",
        messagingSenderId: "437685263224",
        appId: "1:437685263224:web:86cf93d45a7817b6b2868d",
        measurementId: "G-03PKRPYGB3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentRole = "";
    let localData = { pending: {}, chain: {}, students: {}, pending_out: {}, expenses: {} };
    const daftarBulan = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    let inputMode = 'masuk'; // 'masuk' atau 'keluar'

    //pembantu
    let confirmCallback = null;
    function askConfirm(msg, cb) {
        document.getElementById('confirmModalBody').innerText = msg; confirmCallback = cb;
        new bootstrap.Modal(document.getElementById('confirmModal')).show();
    }
    document.getElementById('btnConfirmYes').addEventListener('click', () => { if(confirmCallback) confirmCallback(); });
    function showToast(msg, type='success') {
        const el = document.getElementById('liveToast');
        document.getElementById('toastMessage').innerText = msg;
        el.className = `toast align-items-center text-white bg-${type} border-0`;
        new bootstrap.Toast(el).show();
    }
    function showInlineAlert(id, msg) { document.getElementById(id).innerHTML = `<div class="alert alert-danger py-2 small">${msg}</div>`; }
    function clearInlineAlert(id) { document.getElementById(id).innerHTML = ""; }

    // SETUP
    const renderBulanOptions = (id) => {
        const sel = document.getElementById(id); sel.innerHTML = "";
        daftarBulan.forEach((b, i) => { sel.innerHTML += `<option value="${b}" ${i === new Date().getMonth() ? "selected" : ""}>${b}</option>`; });
    };
    renderBulanOptions('inputBulan'); renderBulanOptions('filterBulanWalas');

    //pembaca database
    onValue(ref(db), (snapshot) => {
        const val = snapshot.val() || {};
        document.getElementById("statusKoneksi").innerText = "Online";
        document.getElementById("statusKoneksi").className = "badge bg-success";
        
        localData.pending = val.pending || {};
        localData.chain = val.chain || {};
        localData.students = val.students || {};
        localData.pending_out = val.pending_out || {};
        localData.expenses = val.expenses || {};

        if (!val.chain) buatGenesis();
        renderUI(); renderManajemenSiswa();
    });

    function buatGenesis() {
        update(ref(db), { "chain/0": { index: 0, waktu: "INIT", nama: "SYSTEM", ket: "Genesis", jumlah: 0, foto: "", prevHash: "0", hash: "0x00000000" } });
    }
    function simpleHash(str) {
        let h = 0; for(let i=0; i<str.length; i++) h = Math.imul(31,h) + str.charCodeAt(i)|0;
        return "0x" + Math.abs(h).toString(16).padStart(8, '0');
    }

    //render ui
    function renderUI() {
        // 1. HITUNG TOTAL SALDO
        let totalMasuk = 0;
        Object.values(localData.chain).forEach(b => totalMasuk += (b.index===0 ? 0 : parseInt(b.jumlah)));
        let totalKeluar = 0;
        Object.values(localData.expenses).forEach(e => totalKeluar += parseInt(e.jumlah));
        
        document.getElementById('displaySaldo').innerText = `Rp ${totalMasuk - totalKeluar}`;
        document.getElementById('displayMasuk').innerText = `Rp ${totalMasuk}`;
        document.getElementById('displayKeluar').innerText = `Rp ${totalKeluar}`;

        //PENDING LIST (Gabungan Masuk & Keluar)
        const lstP = document.getElementById('listPending');
        lstP.innerHTML = "";
        let pendingCount = 0;

        //Pending Masuk
        Object.keys(localData.pending).forEach(k => {
            pendingCount++;
            const i = localData.pending[k];
            let img = i.foto ? `<img src="${i.foto}" class="bukti-foto" onclick="window.open('${i.foto}')">` : "";
            let btn = currentRole==='walas' ? `<div class="mt-2"><button onclick="window.validasiWalas('${k}')" class="btn btn-sm btn-success me-1">ACC</button><button onclick="window.tolak('${k}', 'masuk')" class="btn btn-sm btn-outline-danger">Tolak</button></div>` : "";
            lstP.innerHTML += `<div class="pending-item shadow-sm"><div class="d-flex justify-content-between"><div><span class="badge bg-success mb-1">PEMASUKAN</span><br><strong>${i.nama}</strong><br><small>${i.ket}</small></div><strong class="text-success">+Rp${i.jumlah}</strong></div>${img}${btn}</div>`;
        });

        // Pending Keluar
        Object.keys(localData.pending_out).forEach(k => {
            pendingCount++;
            const i = localData.pending_out[k];
            let img = i.foto ? `<img src="${i.foto}" class="bukti-foto" onclick="window.open('${i.foto}')">` : "";
            let btn = currentRole==='walas' ? `<div class="mt-2"><button onclick="window.validasiPengeluaran('${k}')" class="btn btn-sm btn-success me-1">ACC</button><button onclick="window.tolak('${k}', 'keluar')" class="btn btn-sm btn-outline-danger">Tolak</button></div>` : "";
            lstP.innerHTML += `<div class="pending-item-out shadow-sm"><div class="d-flex justify-content-between"><div><span class="badge bg-danger mb-1">PENGAJUAN KELUAR</span><br><strong>${i.ket}</strong></div><strong class="text-danger">-Rp${i.jumlah}</strong></div>${img}${btn}</div>`;
        });
        
        if(pendingCount===0) lstP.innerHTML = "<small class='text-muted'>Tidak ada antrian.</small>";
        document.getElementById('countPending').innerText = pendingCount;

        //BLOCKCHAIN TABLE (Pemasukan)
        const lstC = document.getElementById('listChain');
        lstC.innerHTML = "";
        [...Object.values(localData.chain)].reverse().forEach(b => {
            let img = b.foto ? `<img src="${b.foto}" style="width:30px; height:30px; object-fit:cover; border-radius:4px; cursor:pointer;" onclick="window.open('${b.foto}')">` : "-";
            let valid = (b.hash === simpleHash(b.prevHash+b.nama+b.jumlah)) || b.index===0;
            let cls = valid ? "" : "row-palsu";
            let badge = valid ? "" : '<br><span class="badge bg-danger">MANIPULASI</span>';
            let del = (currentRole==='walas'&&b.index!==0)? `<button onclick="window.hapusBlock(${b.index})" class="btn btn-link text-danger p-0 ms-2"><i class="bi bi-trash"></i></button>`:"";
            lstC.innerHTML += `<tr class="${cls}"><td><small>${b.waktu.split(',')[0]}</small>${badge}</td><td><strong>${b.nama}</strong><br><small class="text-muted">${b.ket}</small></td><td class="text-center">${img}</td><td class="text-end text-success fw-bold">+Rp${b.jumlah}${del}</td><td><span class="hash-text text-primary">üîí ${b.hash.substring(0,8)}...</span></td></tr>`;
        });

        //EXPENSE TABLE (Pengeluaran)
        const lstE = document.getElementById('listPengeluaran');
        lstE.innerHTML = "";
        const expensesArr = Object.keys(localData.expenses).map(k => ({...localData.expenses[k], key: k}));
        
        if(expensesArr.length === 0) lstE.innerHTML = "<tr><td colspan='5' class='text-center text-muted'>Belum ada pengeluaran.</td></tr>";

        [...expensesArr].reverse().forEach(e => {
            let img = e.foto ? `<img src="${e.foto}" style="width:30px; height:30px; object-fit:cover; border-radius:4px; cursor:pointer;" onclick="window.open('${e.foto}')">` : "-";
            let btnDel = currentRole==='walas' ? `<button onclick="window.hapusPengeluaran('${e.key}')" class="btn btn-sm btn-link text-danger"><i class="bi bi-trash"></i></button>` : "";
            lstE.innerHTML += `<tr><td><small>${e.waktu.split(',')[0]}</small></td><td>${e.ket}</td><td class="text-center">${img}</td><td class="text-end text-danger fw-bold">-Rp${e.jumlah}</td><td>${btnDel}</td></tr>`;
        });
    }

    //INPUT LOGIka
    window.gantiModeInput = (mode) => {
        inputMode = mode;
        if(mode === 'masuk') {
            document.getElementById('panelPemasukan').style.display = 'block';
            document.getElementById('panelPengeluaran').style.display = 'none';
        } else {
            document.getElementById('panelPemasukan').style.display = 'none';
            document.getElementById('panelPengeluaran').style.display = 'block';
        }
    }

    window.prosesInput = function() {
        clearInlineAlert('bendaharaAlertPlaceholder');
        const jml = document.getElementById('inputJumlah').value;
        if(!jml) return showInlineAlert('bendaharaAlertPlaceholder', "Nominal harus diisi!");

        let data = { jumlah: parseInt(jml), waktu: new Date().toLocaleString() };
        let targetNode = "";

        if(inputMode === 'masuk') {
            const nama = document.getElementById('inputNama').value;
            if(!nama) return showInlineAlert('bendaharaAlertPlaceholder', "Pilih siswa!");
            let ket = document.getElementById('tipeIuran').value === 'kas' ? `Kas ${document.getElementById('inputBulan').value} (${document.getElementById('inputMinggu').value})` : document.getElementById('inputKetCustom').value;
            if(!ket) return showInlineAlert('bendaharaAlertPlaceholder', "Keterangan kosong!");
            
            data.nama = nama;
            data.ket = ket;
            targetNode = 'pending';
        } else {
            const ketOut = document.getElementById('ketPengeluaran').value;
            if(!ketOut) return showInlineAlert('bendaharaAlertPlaceholder', "Keperluan pengeluaran harus diisi!");
            data.ket = ketOut;
            targetNode = 'pending_out';
        }

        const send = (foto) => {
            data.foto = foto;
            push(ref(db, targetNode), data);
            showToast("Berhasil diajukan!");
            // Reset
            document.getElementById('inputJumlah').value = "";
            document.getElementById('inputFoto').value = "";
            document.getElementById('ketPengeluaran').value = "";
        };

        const f = document.getElementById('inputFoto').files[0];
        if(f) { const r = new FileReader(); r.onload = e => send(e.target.result); r.readAsDataURL(f); }
        else { send(""); }
    }

    //VALIDASI
    window.validasiWalas = function(key) { // Validasi Pemasukan (Blockchain)
        const item = localData.pending[key];
        if(!item) return;
        const arr = localData.chain ? Object.values(localData.chain) : [];
        arr.sort((a, b) => a.index - b.index);
        if(arr.length===0) {buatGenesis(); return showToast("Sync DB...", "warning");}
        const last = arr[arr.length-1];
        const newIndex = last.index + 1;

        const newBlock = {
            index: newIndex, waktu: new Date().toLocaleString(), nama: item.nama, ket: item.ket, jumlah: item.jumlah, foto: item.foto||"",
            prevHash: last.hash, hash: simpleHash(last.hash + item.nama + item.jumlah)
        };
        set(ref(db, 'chain/'+newIndex), newBlock).then(()=> { remove(ref(db, 'pending/'+key)); showToast("Pemasukan Sah!"); });
    }

    window.validasiPengeluaran = function(key) { // Validasi Pengeluaran (Ledger Biasa)
        const item = localData.pending_out[key];
        if(!item) return;
        push(ref(db, 'expenses'), item).then(() => {
            remove(ref(db, 'pending_out/'+key));
            showToast("Pengeluaran Disetujui.");
        });
    }

    window.tolak = function(key, type) {
        askConfirm("Tolak pengajuan ini?", () => {
            const node = type === 'masuk' ? 'pending' : 'pending_out';
            remove(ref(db, `${node}/${key}`));
            showToast("Ditolak.");
        });
    }

    window.hapusBlock = function(idx) {
        askConfirm("AWAS: Hapus data valid akan merusak Hash!", () => {
            const k = Object.keys(localData.chain).find(key => localData.chain[key].index == idx);
            if(k) remove(ref(db, 'chain/'+k));
        });
    }

    window.hapusPengeluaran = function(key) {
        askConfirm("Hapus data pengeluaran ini?", () => {
            remove(ref(db, 'expenses/'+key));
        });
    }

    //tambahan
    window.tambahSiswa = function() {
        const n = document.getElementById('namaSiswaBaru').value.trim();
        if(!n) return;
        if(Object.values(localData.students).some(s=>s.toLowerCase()===n.toLowerCase())) return alert("Ada!");
        push(ref(db, 'students'), n);
        document.getElementById('namaSiswaBaru').value = "";
    }
    window.hapusSiswa = function(k) { askConfirm("Hapus siswa?", () => remove(ref(db, 'students/'+k))); }
    
    window.renderManajemenSiswa = function() {
        const sel = document.getElementById('inputNama');
        const lst = document.getElementById('listStatusSiswa');
        const bln = document.getElementById('filterBulanWalas').value;
        const arr = Object.keys(localData.students).map(k=>({k, n:localData.students[k]})).sort((a,b)=>a.n.localeCompare(b.n));
        
        sel.innerHTML = '<option value="">-- Pilih --</option>';
        arr.forEach(s => sel.innerHTML += `<option value="${s.n}">${s.n}</option>`);
        
        lst.innerHTML = arr.length===0 ? "<li class='list-group-item'>Kosong</li>" : "";
        arr.forEach(s => {
            const cek = (m) => Object.values(localData.chain).find(b => b.nama === s.n && b.ket.includes(`Kas ${bln}`) && b.ket.includes(m));
            const st = (m) => cek(m) ? "bg-paid" : "bg-not-paid";
            lst.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center"><div><div class="fw-bold">${s.n}</div><div class="d-flex mt-1"><span class="status-box ${st('Minggu 1')}">M1</span><span class="status-box ${st('Minggu 2')}">M2</span><span class="status-box ${st('Minggu 3')}">M3</span><span class="status-box ${st('Minggu 4')}">M4</span></div></div><button onclick="window.hapusSiswa('${s.k}')" class="btn btn-sm text-danger"><i class="bi bi-trash"></i></button></li>`;
        });
    }

    window.cekTipeIuran = function() {
        const t = document.getElementById('tipeIuran').value;
        document.getElementById('formKasRutin').style.display = t==='kas'?'flex':'none';
        document.getElementById('formCustom').style.display = t==='custom'?'block':'none';
    }

    // AUTH
    window.cekRoleLogin = function() {
        const r = document.getElementById('roleSelect').value;
        document.getElementById('passwordField').style.display = (r==='siswa'||r==='')?'none':'block';
        clearInlineAlert('loginAlertPlaceholder');
        document.getElementById('passInput').value = "";
    }
    window.togglePassword = function() {
        const p = document.getElementById('passInput'); const i = document.getElementById('iconEye');
        if(p.type==='password'){p.type='text';i.classList.replace('bi-eye','bi-eye-slash');}
        else{p.type='password';i.classList.replace('bi-eye-slash','bi-eye');}
    }
    window.login = function() {
        clearInlineAlert('loginAlertPlaceholder');
        const r = document.getElementById('roleSelect').value;
        const p = document.getElementById('passInput').value;
        if(!r) return showInlineAlert('loginAlertPlaceholder', "Pilih peran!");
        let ok = (r==='siswa') || (r==='bendahara'&&p==='123') || (r==='walas'&&p==='guru');
        if(ok) {
            currentRole=r;
            document.getElementById('hal-login').style.display='none';
            document.getElementById('mainApp').style.display='block';
            document.getElementById('userRoleDisplay').innerText = r.toUpperCase();
            document.getElementById('InputWalas').style.display = (r==='walas')?'block':'none';
            document.getElementById('InputBendahara').style.display = (r==='bendahara')?'block':'none';
            renderUI(); renderManajemenSiswa();
            showToast(`Halo ${r.toUpperCase()}`);
        } else { showInlineAlert('loginAlertPlaceholder', "Password salah!"); }
    }
    window.logout = function() { location.reload(); }
</script>
</body>
</html>
